name: Release Custom Podkop

on:
  push:
    tags:
      - 'podkop-v*'

permissions:
  contents: write

jobs:
  preparation:
    name: Prepare version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.ver.outputs.version }}
    steps:
      - uses: actions/checkout@v4
      - id: ver
        run: |
          VERSION="${GITHUB_REF_NAME#podkop-v}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

  build:
    name: Build ${{ matrix.package_type }}
    runs-on: ubuntu-latest
    needs: preparation
    strategy:
      matrix:
        package_type: [ipk, apk]
    steps:
      - uses: actions/checkout@v4

      - name: Build docker image
        uses: docker/build-push-action@v6
        with:
          context: ./_podkop_upstream
          file: ./_podkop_upstream/Dockerfile-${{ matrix.package_type }}
          tags: custom-podkop:ci-${{ matrix.package_type }}
          build-args: |
            PODKOP_VERSION=${{ needs.preparation.outputs.version }}

      - name: Create container
        run: docker create --name build-${{ matrix.package_type }} custom-podkop:ci-${{ matrix.package_type }}

      - name: Extract artifacts
        run: |
          mkdir -p ./bin/${{ matrix.package_type }}
          docker cp build-${{ matrix.package_type }}:/builder/bin/packages/x86_64/utilities/. ./bin/${{ matrix.package_type }}/
          docker cp build-${{ matrix.package_type }}:/builder/bin/packages/x86_64/luci/. ./bin/${{ matrix.package_type }}/

      - name: Normalize names for ipk
        if: matrix.package_type == 'ipk'
        run: |
          for f in ./bin/${{ matrix.package_type }}/*.${{ matrix.package_type }}; do
            [ -e "$f" ] || continue
            base=$(basename "$f")
            newname=$(echo "$base" | sed 's/_/-/g')
            mv "$f" "./bin/${{ matrix.package_type }}/$newname"
          done

      - name: Filter release files
        run: |
          VERSION="${{ needs.preparation.outputs.version }}"
          mkdir -p ./filtered/${{ matrix.package_type }}
          cp ./bin/${{ matrix.package_type }}/podkop-*.${{ matrix.package_type }} ./filtered/${{ matrix.package_type }}/
          cp ./bin/${{ matrix.package_type }}/luci-app-podkop-*.${{ matrix.package_type }} ./filtered/${{ matrix.package_type }}/
          if ls ./bin/${{ matrix.package_type }}/luci-i18n-podkop-ru-* 1>/dev/null 2>&1; then
            cp ./bin/${{ matrix.package_type }}/luci-i18n-podkop-ru-*.${{ matrix.package_type }} ./filtered/${{ matrix.package_type }}/luci-i18n-podkop-ru-${VERSION}.${{ matrix.package_type }}
          fi

      - name: Cleanup container
        run: docker rm build-${{ matrix.package_type }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: custom-podkop-${{ matrix.package_type }}
          path: ./filtered/${{ matrix.package_type }}/*.${{ matrix.package_type }}
          if-no-files-found: error

  release:
    name: Publish release
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - name: Create release folder
        run: mkdir -p ./release

      - name: Download ipk artifacts
        uses: actions/download-artifact@v4
        with:
          name: custom-podkop-ipk
          path: ./release

      - name: Download apk artifacts
        uses: actions/download-artifact@v4
        with:
          name: custom-podkop-apk
          path: ./release

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          files: ./release/*
          name: Custom Podkop ${{ github.ref_name }}
          tag_name: ${{ github.ref_name }}
          draft: false
          prerelease: false
